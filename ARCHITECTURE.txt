â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 ğŸš RPi DRONE CONTROL - SYSTEM ARCHITECTURE                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            YOUR PC / BROWSER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  http://172.20.10.5:8000/login      POST /login (credentials)              â”‚
â”‚          â†“                           â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Login Page (HTML)   â”‚â”€â”€â”€â†’   Form â†’ JSON â†’ Fetch API         â”‚          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”‚ â”‚ Username: [___] â”‚ â”‚              â†“                                    â”‚
â”‚  â”‚ â”‚ Password: [___] â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ â”‚ [Login Button]  â”‚ â”‚   â”‚ Server Response: 200 OK            â”‚          â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ Cookie: session_id=<token>         â”‚          â”‚
â”‚  â”‚                     â”‚   â”‚ Redirect: /map                     â”‚          â”‚
â”‚  â”‚ Demo Credentials:   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”‚ admin / admin123    â”‚              â†“                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Automatic redirect                              â”‚
â”‚                                 â†“                                           â”‚
â”‚                       GET /map (with cookie)                                â”‚
â”‚                                 â†“                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚         Map Page (Leaflet.js)                â”‚                          â”‚
â”‚  â”‚                                              â”‚                          â”‚
â”‚  â”‚  â•”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚
â”‚  â”‚  â•‘ HUD (Terminal Style - Green)         â•‘   â”‚                          â”‚
â”‚  â”‚  â•‘ WS Status: Live  ğŸŸ¢ [PULSING]       â•‘   â”‚                          â”‚
â”‚  â”‚  â•‘ Lat: 36.80652  Lon: 10.18154       â•‘   â”‚                          â”‚
â”‚  â”‚  â•‘ Alt: 15.3m     Speed: 2.52 m/s     â•‘   â”‚                          â”‚
â”‚  â”‚  â•‘ Heading: 45.0Â°  Battery: 85%       â•‘   â”‚                          â”‚
â”‚  â”‚  â•‘ [Follow: OFF]  [Logout]            â•‘   â”‚                          â”‚
â”‚  â”‚  â•šâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚
â”‚  â”‚                                              â”‚                          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚
â”‚  â”‚  â”‚  Leaflet Map (OSM)                   â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚                                      â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚      ğŸš  Drone (Rotating)            â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚     /  Polyline (Flight Path)        â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚    /                                 â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚   O  [Tunis Area]                    â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚                                      â”‚   â”‚                          â”‚
â”‚  â”‚  â”‚  [+] [-] [Map Controls]              â”‚   â”‚                          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚
â”‚  â”‚                                              â”‚                          â”‚
â”‚  â”‚  WebSocket Connected âœ“                      â”‚                          â”‚
â”‚  â”‚  Receiving data every 0.5s                  â”‚                          â”‚
â”‚  â”‚  Auto-reconnect if disconnected             â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                              â”‚
â”‚  JavaScript (map.js):                                                       â”‚
â”‚  â€¢ Auto-detect: ws:// (local) vs wss:// (HTTPS)                           â”‚
â”‚  â€¢ Connect to ws://172.20.10.5:8000/ws + cookie                           â”‚
â”‚  â€¢ Listen for JSON messages                                                â”‚
â”‚  â€¢ Update HUD + map markers                                                â”‚
â”‚  â€¢ Auto-reconnect every 1 sec on disconnect                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                          â†‘                         â†‘
         â”‚                          â”‚                         â”‚
         â”‚ HTTP/HTTPS               â”‚ WebSocket             â”‚
         â”‚ (regular requests)       â”‚ (live stream)         â”‚
         â”‚                          â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RASPBERRY PI - BACKEND                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€ FastAPI Application â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  Port 8000 (uvicorn server)                                       â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€ Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  GET  /           â†’ Redirect /map (auth) or /login (no)  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  GET  /login      â†’ Serve login.html (no auth required)  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  POST /login      â†’ Authenticate + create session        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  GET  /logout     â†’ Destroy session + clear cookie       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  GET  /map        â†’ Serve map.html (SESSION REQUIRED)    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  GET  /health     â†’ {"ok": true, "version": "0.2.0"}    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  ws://0.0.0.0:8000/ws                                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  1. Client connects with cookie                           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  2. Extract session_id from cookie header                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  3. Validate session in auth.validate_session()          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  4. If invalid: Close with code 1008                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  5. If valid:   Accept connection + add to broadcast    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  6. Receive telemetry messages every 0.5s               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€ Session Management (backend/auth.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  ACTIVE_SESSIONS = {                                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    "token_abc123...": {                                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚      "username": "admin",                                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚      "created_at": DateTime,                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚      "last_accessed": DateTime                           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    }                                                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  }                                                        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Functions:                                              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ authenticate_user(username, password) â†’ bool         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ create_session(username) â†’ token                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ validate_session(token) â†’ username or None          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ destroy_session(token) â†’ bool                        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ set_session_cookie(response, token)                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€ Telemetry Broadcast (backend/websocket.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  ConnectionManager                                        â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ active_connections: Set[WebSocket]                   â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ async connect(ws) â†’ Accept + register               â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ disconnect(ws) â†’ Unregister                          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ async broadcast(data) â†’ Send to all                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  Message Format:                                        â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  {                                                       â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "lat": 36.8065,      # Latitude                     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "lon": 10.1815,      # Longitude                    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "alt": 15.3,         # Altitude (m)                â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "heading": 45.0,     # Heading (deg)               â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "speed": 2.5,        # Speed (m/s)                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "battery": 85.0,     # Battery (%)                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    "ts": 1704067200     # Timestamp                   â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  }                                                       â”‚   â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  Frequency: Every 0.5 seconds                           â”‚   â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€ Demo Telemetry Loop (backend/server.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  async def demo_telemetry_loop(manager):                  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚      while True:                                          â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          counter += 1                                     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          # Generate circular flight around Tunis        â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          angle = (counter * 2.0) % 360                 â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          lat = 36.8065 + radius * cos(angle)           â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          lon = 10.1815 + radius * sin(angle)           â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          alt = 10 + (counter % 50) * 0.5               â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          telemetry = {lat, lon, alt, heading, ...}     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          await manager.broadcast(telemetry)             â”‚ â”‚    â”‚
â”‚  â”‚  â”‚          await asyncio.sleep(0.5)                      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  Static Files (frontend):                                                  â”‚
â”‚  â€¢ /static/login.html     (served as-is)                                  â”‚
â”‚  â€¢ /static/map.html       (served as-is)                                  â”‚
â”‚  â€¢ /static/map.js         (loaded by browser)                             â”‚
â”‚  â€¢ /static/map.css        (loaded by browser)                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        DATA FLOW SEQUENCE                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOGIN SEQUENCE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Browser      â†’ GET http://172.20.10.5:8000/login
2. Server       â†’ Return login.html
3. Browser      â†’ Display form
4. User         â†’ Enter admin / admin123
5. Browser      â†’ POST /login { username, password }
6. Server       â†’ auth.authenticate_user() âœ“
7. Server       â†’ session_id = auth.create_session("admin")
8. Server       â†’ auth.set_session_cookie(response, session_id)
9. Server       â†’ Return 200 OK
10. Browser     â†’ Receive cookie: session_id=<token>
11. Browser     â†’ Redirect GET /map
12. Server      â†’ Validate cookie session
13. Server      â†’ Return map.html
14. Browser     â†’ Load map.js + map.css + Leaflet CDN
15. JavaScript  â†’ Detect protocol (http â†’ ws:// or https â†’ wss://)
16. JavaScript  â†’ Connect to ws://172.20.10.5:8000/ws + cookie
17. Server      â†’ Extract session_id from Cookie header
18. Server      â†’ auth.validate_session(session_id) âœ“
19. Server      â†’ manager.connect(websocket)
20. Server      â†’ Add to active_connections set
21. Browser     â†’ Receive first telemetry message
22. JavaScript  â†’ Update HUD + map marker + polyline
23. Repeat      â†’ Every 0.5 seconds


WEBSOCKET PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
If user tries to connect to /ws WITHOUT being logged in:

1. Browser      â†’ Connect to ws://.../ 
2. Server       â†’ Extract session_id from headers
3. Server       â†’ session_id = "" (no cookie)
4. Server       â†’ auth.validate_session("") â†’ None
5. Server       â†’ await websocket.close(code=1008, reason="...")
6. Browser      â†’ WebSocket closed immediately
7. JavaScript   â†’ Catch error, retry every 1 sec
8. Eventually   â†’ User is redirected to /login


LOGOUT SEQUENCE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. User         â†’ Click "Logout" button
2. JavaScript   â†’ Fetch GET /logout
3. Browser      â†’ Send Cookie: session_id=<token>
4. Server       â†’ auth.destroy_session(session_id)
5. Server       â†’ auth.delete_session_cookie(response)
6. Server       â†’ Redirect to /login
7. Browser      â†’ Follow redirect
8. WebSocket    â†’ Disconnects (no more broadcasts)
9. JavaScript   â†’ Tries to reconnect every 1 sec
10. Server      â†’ Rejects (session gone)
11. User        â†’ Sees "Disconnected" in HUD

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     FILE DEPENDENCIES & IMPORTS                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

backend/server.py:
  â”œâ”€ from backend import auth        â†’ Session management
  â”œâ”€ from backend import websocket   â†’ WebSocket manager
  â”œâ”€ from backend import api         â†’ REST API routes
  â”œâ”€ from fastapi import FastAPI     â†’ Web framework
  â””â”€ from fastapi.staticfiles        â†’ Serve HTML/CSS/JS

backend/websocket.py:
  â”œâ”€ from backend import auth        â†’ Session validation
  â”œâ”€ from fastapi import WebSocket   â†’ WebSocket protocol
  â””â”€ from typing import Set          â†’ Type hints

backend/auth.py:
  â”œâ”€ from datetime import datetime   â†’ Session timestamps
  â”œâ”€ from fastapi import Response    â†’ HTTP response
  â””â”€ import secrets                  â†’ Generate tokens

frontend/map.js:
  â”œâ”€ L.map()          â†’ Leaflet (from CDN)
  â”œâ”€ fetch()          â†’ Modern browsers
  â”œâ”€ WebSocket        â†’ Modern browsers
  â””â”€ JSON.parse()     â†’ Built-in

frontend/map.html:
  â”œâ”€ <link> Leaflet CSS     (from CDN)
  â”œâ”€ <script> Leaflet JS    (from CDN)
  â””â”€ <script> map.js        (local)

frontend/login.html:
  â”œâ”€ <form> standard HTML
  â”œâ”€ fetch() for POST /login
  â””â”€ window.location.href redirect

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ENVIRONMENT VARIABLES                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Production Setup:
â”œâ”€ HOST              = "0.0.0.0"      (Listen on all interfaces)
â”œâ”€ PORT              = 8000           (uvicorn port)
â”œâ”€ SECRET_KEY        = <random>       (for token signing - TODO)
â”œâ”€ DATABASE_URL      = "postgresql://..." (for sessions - TODO)
â”œâ”€ SESSION_TIMEOUT   = 86400          (24 hours)
â”œâ”€ HTTPS_ONLY        = false          (local) or true (production)
â”œâ”€ CORS_ORIGINS      = ["*"]          (TODO: restrict)
â””â”€ LOG_LEVEL         = "info"         (DEBUG for dev)

Current (Local Demo):
â”œâ”€ Everything in-memory
â”œâ”€ HTTP (not HTTPS)
â”œâ”€ Session dict: ACTIVE_SESSIONS = {}
â”œâ”€ No database
â””â”€ 24h timeout

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              END OF DIAGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
